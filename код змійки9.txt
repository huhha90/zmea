import pygame
import random
import sys
import os
import json
import traceback
import datetime
import webbrowser
from pygame.locals import *

WIDTH = 800
HEIGHT = 600
CELL_SIZE = 20
BG_COLOR = (10, 10, 10)
BUTTON_COLOR = (50, 50, 50)
HOVER_COLOR = (100, 100, 100)
TEXT_COLOR = (0, 255, 0)
FOOD_COLOR = (255, 0, 0)
SPECIAL_FOOD_COLOR = (0, 0, 255)
SETTINGS_FILE = "settings.json"
LEADERBOARD_FILE = "leaderboard.json"
ERROR_LOG_FILE = "error_log.txt"
FOOD_COUNT = 5
SPECIAL_FOOD_CHANCE = 0.1

# –õ–æ–≥—É–≤–∞–Ω–Ω—è –ø–æ–º–∏–ª–æ–∫
def log_exception():
    with open(ERROR_LOG_FILE, "a", encoding="utf-8") as f:
        f.write(f"\n=== [{datetime.datetime.now().strftime('%Y-%m-%d %H:%M:%S')}] ===\n")
        traceback.print_exc(file=f)

# === –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –ø–æ—à—É–∫—É —à–ª—è—Ö—É –¥–æ —Ä–µ—Å—É—Ä—Å—ñ–≤ (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, –¥–ª—è PyInstaller) ===
def resource_path(relative_path):
    try:
        base_path = sys._MEIPASS
    except Exception:
        base_path = os.path.abspath(".")
    return os.path.join(base_path, relative_path)

def load_leaderboard():
    try:
        with open(LEADERBOARD_FILE, "r", encoding="utf-8") as file:
            return json.load(file)
    except (FileNotFoundError, json.JSONDecodeError):
        return []
    
# –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω—å
def save_settings(settings):
    with open("settings.json", "w") as f:
        json.dump(settings, f)

# –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω—å
def load_settings():
    if os.path.exists("settings.json"):
        with open("settings.json", "r") as f:
            return json.load(f)
    else:
        return {
            "sound": True,
            "music": True,
            "nickname": "Player",
            "language": "uk"
        }

# –ö–ª–∞—Å –≥—Ä–∏
class SnakeGame:
    def __init__(self):
        pygame.init()
        pygame.mixer.init()
        self.width = 800
        self.height = 600
        self.screen = pygame.display.set_mode((self.width, self.height))  # –ø–æ—Ç—Ä—ñ–±–Ω–æ –¥–ª—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è
        self.clock = pygame.time.Clock()
        self.loading_screen()

        self.play_menu_music()
        self.font = pygame.font.Font(None, 36)
        self.screen = pygame.display.set_mode((self.width, self.height))
        self.leaderboard = ["–ì—Ä–∞–≤–µ—Ü—å 1", "–ì—Ä–∞–≤–µ—Ü—å 2"]
        self.training_mode = False
        self.new_level_unlocked_message = ""
        self.new_level_timer = pygame.time.get_ticks()
        self.next_level_available = False

        self.settings = load_settings()
        self.leaderboard = load_leaderboard()  # –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ —Ç–∞–±–ª–∏—Ü—é –ª—ñ–¥–µ—Ä—ñ–≤
        self.screen = pygame.display.set_mode((0, 0), pygame.FULLSCREEN)
        self.width, self.height = self.screen.get_size()
        pygame.display.set_caption("–ó–ú–Ü–ô–ö–ê")
        self.clock = pygame.time.Clock()
        self.running = True
        self.sounds = {
            "eat": pygame.mixer.Sound(resource_path("assets/music/eat.wav")),
            "collision": pygame.mixer.Sound(resource_path("assets/music/collision.wav")),
            "click": pygame.mixer.Sound(resource_path("assets/music/click.wav"))
        }
        # –°–ª–æ–≤–Ω–∏–∫ –¥–ª—è –º–æ–≤
        self.languages = {
          "uk": {"play": "–ì—Ä–∞—Ç–∏", "levels": "–†—ñ–≤–Ω—ñ", "train": "–¢—Ä–µ–Ω—É–≤–∞–Ω–Ω—è", "leaderboard": "–¢–∞–±–ª–∏—Ü—è –ª—ñ–¥–µ—Ä—ñ–≤", "settings": "–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è", "exit": "–í–∏—Ö—ñ–¥", "save": "–ó–±–µ—Ä–µ–≥—Ç–∏", "change_nickname": "–ó–º—ñ–Ω–∏—Ç–∏ –Ω—ñ–∫"},
          "en": {"play": "Play", "levels": "Levels", "train": "Training", "leaderboard": "Leaderboard", "settings": "Settings", "exit": "Exit", "save": "Save", "change_nickname": "Change Nickname"},
          "ru": {"play": "–ò–≥—Ä–∞—Ç—å", "levels": "–£—Ä–æ–≤–Ω–∏", "train": "–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞", "leaderboard": "–¢–∞–±–ª–∏—Ü–∞ –ª–∏–¥–µ—Ä–æ–≤", "settings": "–ù–∞—Å—Ç—Ä–æ–π–∫–∏", "exit": "–í—ã—Ö–æ–¥", "save": "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å", "change_nickname": "–ò–∑–º–µ–Ω–∏—Ç—å –Ω–∏–∫"},
          "pl": {"play": "Graj", "levels": "Poziomy", "train": "Trening", "leaderboard": "Tabela lider√≥w", "settings": "Ustawienia", "exit": "Wyj≈õcie", "save": "Zapisz", "change_nickname": "Zmie≈Ñ pseudonim"},
          "de": {"play": "Spielen", "levels": "Level", "train": "Training", "leaderboard": "Bestenliste", "settings": "Einstellungen", "exit": "Beenden", "save": "Speichern", "change_nickname": "Nickname √§ndern"},
          "ja": {"play": "„Éó„É¨„Ç§", "levels": "„É¨„Éô„É´", "train": "„Éà„É¨„Éº„Éã„É≥„Ç∞", "leaderboard": "„É™„Éº„ÉÄ„Éº„Éú„Éº„Éâ", "settings": "Ë®≠ÂÆö", "exit": "ÁµÇ‰∫Ü", "save": "‰øùÂ≠ò", "change_nickname": "„Éã„ÉÉ„ÇØ„Éç„Éº„É†Â§âÊõ¥"},
          "zh": {"play": "Áé©", "levels": "ÂÖ≥Âç°", "train": "ËÆ≠ÁªÉ", "leaderboard": "ÊéíË°åÊ¶ú", "settings": "ËÆæÁΩÆ", "exit": "ÈÄÄÂá∫", "save": "‰øùÂ≠ò", "change_nickname": "Êõ¥ÊîπÊòµÁß∞"},
          "be": {"play": "–ì—É–ª—è—Ü—å", "levels": "–†–∞—û–Ω—ñ", "train": "–¢—Ä—ç–Ω—ñ—Ä–æ—û–∫–∞", "leaderboard": "–¢–∞–±–ª—ñ—Ü–∞ –ª—ñ–¥–∞—Ä–∞—û", "settings": "–ù–∞–ª–∞–¥–∞", "exit": "–í—ã—Ö–æ–¥", "save": "–ó–∞—Ö–∞–≤–∞—Ü—å", "change_nickname": "–ó–º—è–Ω—ñ—Ü—å –Ω—ñ–∫–∞"},
          "cs": {"play": "Hr√°t", "levels": "√örovnƒõ", "train": "Tr√©nink", "leaderboard": "≈Ωeb≈ô√≠ƒçek", "settings": "Nastaven√≠", "exit": "Konec", "save": "Ulo≈æit", "change_nickname": "Zmƒõnit p≈ôezd√≠vku"},
          "tr": {"play": "Oyna", "levels": "Seviyeler", "train": "Antrenman", "leaderboard": "Lider Tablosu", "settings": "Ayarlar", "exit": "√áƒ±kƒ±≈ü", "save": "Kaydet", "change_nickname": "Takma ad deƒüi≈ütir"}
        }


        
        self.show_menu()

    def draw_emoji(self, name, x, y, size=64):
        try: 
         path = resource_path(f"assets/emoji/{name}.png")
         img = pygame.image.load(path).convert_alpha()
         img = pygame.transform.scale(img, (size, size))
         self.screen.blit(img, (x, y))
        except Exception as e:
         print(f"‚ùå –ï–º–æ–¥–∑—ñ '{name}' –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ –∞–±–æ –Ω–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ:", e)


    def show_menu(self):
        menu_active = True
        lang = self.settings["language"]

        # –¢–µ–∫—Å—Ç–∏ –∫–Ω–æ–ø–æ–∫
        buttons = [
            self.languages[lang]["play"],
            self.languages[lang]["levels"],
            self.languages[lang]["train"],
            self.languages[lang]["leaderboard"],
            self.languages[lang]["change_nickname"],
            self.languages[lang]["settings"],
            self.languages[lang]["exit"]
        ]

        # –í—ñ–¥–ø–æ–≤—ñ–¥–Ω—ñ —Ñ—É–Ω–∫—Ü—ñ—ó
        actions = [
            self.run_game,
            self.level_select_menu,
            self.run_training_mode,
            self.show_leaderboard,
            self.change_nickname,
            self.show_settings,
            self.exit_game
        ]

        while menu_active:
            self.screen.fill(BG_COLOR)

            # –ó–∞–≥–æ–ª–æ–≤–æ–∫
            title_text = self.font.render("–ó–ú–Ü–ô–ö–ê", True, TEXT_COLOR)
            self.screen.blit(title_text, (self.width // 2 - title_text.get_width() // 2, 100))

            # –ú–∞–ª—é–≤–∞–Ω–Ω—è –∫–Ω–æ–ø–æ–∫
            button_rects = []
            for i, text in enumerate(buttons):
                rect = pygame.Rect(self.width // 2 - 150, 250 + i * 80, 300, 60)
                button_rects.append(rect)
                pygame.draw.rect(self.screen, BUTTON_COLOR, rect, border_radius=10)
                label = self.font.render(text, True, TEXT_COLOR)
                self.screen.blit(label, (rect.centerx - label.get_width() // 2, rect.centery - label.get_height() // 2))

            pygame.display.flip()

            # –û–±—Ä–æ–±–∫–∞ –ø–æ–¥—ñ–π
            for event in pygame.event.get():
                if event.type == pygame.QUIT:
                    self.exit_game()
                elif event.type == pygame.MOUSEBUTTONDOWN:
                    for i, rect in enumerate(button_rects):
                        if rect.collidepoint(event.pos):
                            if self.settings["sound"]:
                                self.sounds["click"].play()
                            menu_active = False
                            actions[i]()  # –í–∏–∫–ª–∏–∫–∞—î–º–æ –ø–æ—Ç—Ä—ñ–±–Ω—É —Ñ—É–Ω–∫—Ü—ñ—é

    

    def load_levels(self):
        try:
           with open("levels.json", "r", encoding="utf-8") as f:
            return json.load(f)
        except Exception as e:
          print("–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ levels.json:", e)
        return []


    def load_level_progress(self):
        if os.path.exists("level_progress.json"):
          with open("level_progress.json", "r", encoding="utf-8") as f:
            return json.load(f)
        else:
         return {"unlocked_levels": [0]}   
         

    def save_level_progress(self, progress):
        with open("level_progress.json", "w", encoding="utf-8") as f:
         json.dump(progress, f)

    def level_select_menu(self):
        print("üîç –í—ñ–¥–∫—Ä–∏–≤–∞—î–º–æ –º–µ–Ω—é –≤–∏–±–æ—Ä—É —Ä—ñ–≤–Ω—ñ–≤")

        try:
          self.levels = self.load_levels()
          print("‚úÖ –†—ñ–≤–Ω—ñ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ:", len(self.levels))
        except Exception as e:
          print("‚ùå –ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ —Ä—ñ–≤–Ω—ñ–≤:", e)
          self.levels = []

        try:
         self.level_progress = self.load_level_progress()
         print("‚úÖ –ü—Ä–æ–≥—Ä–µ—Å —Ä—ñ–≤–Ω—ñ–≤:", self.level_progress)
        except Exception as e:
         print("‚ùå –ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ –ø—Ä–æ–≥—Ä–µ—Å—É:", e)
         self.level_progress = {"unlocked_levels": [0]}

        selected = None
        running = True

        cols = 5
        spacing = 20
        btn_w = 100
        btn_h = 60
        start_x = (self.width - (btn_w + spacing) * cols) // 2
        start_y = 150

        while running:
         self.screen.fill(BG_COLOR)
         title = self.font.render("–í–∏–±—ñ—Ä —Ä—ñ–≤–Ω—è", True, TEXT_COLOR)
         self.screen.blit(title, (self.width // 2 - title.get_width() // 2, 50))

        level_buttons = []

        for i in range(len(self.levels)):
            col = i % cols
            row = i // cols
            x = start_x + col * (btn_w + spacing)
            y = start_y + row * (btn_h + spacing)
            rect = pygame.Rect(x, y, btn_w, btn_h)

            if i in self.level_progress.get("unlocked_levels", [0]):
                pygame.draw.rect(self.screen, (0, 180, 0), rect, border_radius=10)
                text = self.font.render(str(i + 1), True, (0, 0, 0))
                self.screen.blit(text, (rect.centerx - text.get_width() // 2, rect.centery - text.get_height() // 2))
            else:
                pygame.draw.rect(self.screen, (100, 100, 100), rect, border_radius=10)
                try:
                    self.draw_emoji("lock", rect.centerx - 32, rect.centery - 32, 64)
                except Exception as emoji_error:
                    print("‚ö† –ü–æ–º–∏–ª–∫–∞ –µ–º–æ–¥–∑—ñ:", emoji_error)

            level_buttons.append((rect, i))

        # –ö–Ω–æ–ø–∫–∞ –Ω–∞–∑–∞–¥
        back_button = pygame.Rect(self.width // 2 - 75, self.height - 80, 150, 50)
        pygame.draw.rect(self.screen, BUTTON_COLOR, back_button, border_radius=10)
        back_label = self.font.render("–ù–∞–∑–∞–¥", True, TEXT_COLOR)
        self.screen.blit(back_label, (back_button.centerx - back_label.get_width() // 2, back_button.centery - back_label.get_height() // 2))

        pygame.display.flip()

        for event in pygame.event.get():
            if event.type == pygame.QUIT:
                self.exit_game()
            elif event.type == pygame.KEYDOWN:
                if event.key == pygame.K_ESCAPE:
                    print("üîô ESC - –≤–∏—Ö—ñ–¥ –¥–æ –º–µ–Ω—é")
                    running = False
                    self.show_menu()
                    return
            elif event.type == pygame.MOUSEBUTTONDOWN:
                if back_button.collidepoint(event.pos):
                    print("üîô –ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é")
                    running = False
                    self.show_menu()
                    return
                for rect, i in level_buttons:
                    if rect.collidepoint(event.pos) and i in self.level_progress.get("unlocked_levels", [0]):
                        print(f"üéØ –í–∏–±—Ä–∞–Ω–æ —Ä—ñ–≤–µ–Ω—å {i}")
                        selected = i
                        running = False
                        break

        self.clock.tick(60)

        if selected is not None:
         self.current_level = selected
         self.run_game_with_level(selected)

    def setup_buttons(self):
            self.buttons = []
            print("üõ† –°—Ç–≤–æ—Ä—é—î–º–æ –∫–Ω–æ–ø–∫–∏ –¥–ª—è —Ä—ñ–≤–Ω—ñ–≤...")
            for i, level in enumerate(self.levels):
             print(f"‚ûï –ö–Ω–æ–ø–∫–∞ –¥–ª—è —Ä—ñ–≤–Ω—è {i} ‚Äî {level['name']}")
            x = 100 + (i % 5) * 130
            y = 150 + (i // 5) * 80
            button = Button((x, y, 120, 50), level["name"], lambda i=i: self.start_level(i))
            self.buttons.append(button)
            print("‚úÖ –£—Å—å–æ–≥–æ –∫–Ω–æ–ø–æ–∫ —Å—Ç–≤–æ—Ä–µ–Ω–æ:", len(self.buttons))

    def start_snake_with_level(self, level_data):
       self.head_pos = pygame.math.Vector2(self.width // 2, self.height // 2)
       self.direction_vector = pygame.math.Vector2(1, 0)
       self.snake = [self.head_pos.copy() - pygame.math.Vector2(i * CELL_SIZE, 0) for i in range(5)]
       self.head_pos = self.snake[0].copy()
       self.score = 0.0
       self.fps = level_data["speed"]
       self.speed = CELL_SIZE  # —Ü—è –∑–º—ñ–Ω–Ω–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—î –∑–∞ –¥–æ–≤–∂–∏–Ω—É –∫—Ä–æ–∫—É, –Ω–µ –∑–∞ —à–≤–∏–¥–∫—ñ—Å—Ç—å
       global FOOD_COUNT, SPECIAL_FOOD_CHANCE
       FOOD_COUNT = level_data["food_count"]
       SPECIAL_FOOD_CHANCE = level_data["special_food_chance"]
       self.foods = self.generate_foods()
    # –ü–∞—Å—Ç–∫–∏ –ø–æ–∫–∏ —â–æ –Ω–µ —Ä–µ–∞–ª—ñ–∑—É—î–º–æ, –ø—ñ–∑–Ω—ñ—à–µ

    def show_leaderboard(self):
        leaderboard_active = True
        self.screen.fill(BG_COLOR)

    # –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –∫–Ω–æ–ø–∫–∏ "–ù–∞–∑–∞–¥"
        back_button = pygame.Rect(self.width // 2 - 75, 600, 150, 50)

    # –ó–∞–≥–æ–ª–æ–≤–æ–∫
        title_text = self.font.render(self.languages[self.settings["language"]]["leaderboard"], True, TEXT_COLOR)
        self.screen.blit(title_text, (self.width // 2 - title_text.get_width() // 2, 100))

    # –í–∏–≤—ñ–¥ –µ–ª–µ–º–µ–Ω—Ç—ñ–≤ —Ç–∞–±–ª–∏—Ü—ñ
        for i in range(len(self.leaderboard)):
         if isinstance(self.leaderboard[i], dict):
            rect = pygame.Rect(self.width // 2 - 150, 250 + i * 80, 300, 60)
            text = f"{self.leaderboard[i]['nickname']} - {self.leaderboard[i]['score']}"
            label = self.font.render(text, True, TEXT_COLOR)
            self.screen.blit(label, (rect.centerx - label.get_width() // 2, rect.centery - label.get_height() // 2))

    # –ú–∞–ª—é–≤–∞–Ω–Ω—è –∫–Ω–æ–ø–∫–∏
        pygame.draw.rect(self.screen, BUTTON_COLOR, back_button, border_radius=10)
        back_label = self.font.render(self.languages[self.settings["language"]]["exit"], True, TEXT_COLOR)
        self.screen.blit(back_label, (
        back_button.centerx - back_label.get_width() // 2,
        back_button.centery - back_label.get_height() // 2
    ))

        pygame.display.flip()

    # –¶–∏–∫–ª –ø–æ–¥—ñ–π
        while leaderboard_active:
                 for event in pygame.event.get():
                    if event.type == pygame.QUIT:
                      self.exit_game()
                    elif event.type == pygame.MOUSEBUTTONDOWN:
                     if back_button.collidepoint(event.pos):
                         leaderboard_active = False
                         self.show_menu()

    def save_score_to_leaderboard(self, training=False):
     if self.score > 0:
        nickname = self.settings.get("nickname", "Player")
        if training:
            nickname += " (—Ç—Ä–µ–Ω—É–≤–∞–Ω–Ω—è)"
        self.leaderboard.append({
            "nickname": nickname,
            "score": self.score
        })
        self.leaderboard = sorted(self.leaderboard, key=lambda x: x["score"], reverse=True)[:10]
        with open(LEADERBOARD_FILE, "w", encoding="utf-8") as file:
            json.dump(self.leaderboard, file, indent=4)

    def show_settings(self):
        settings_active = True
        while settings_active:
            self.screen.fill(BG_COLOR)
            title_text = self.font.render("–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è", True, TEXT_COLOR)
            self.screen.blit(title_text, (WIDTH // 2 - title_text.get_width() // 2, 100))

            sound_button = pygame.Rect(WIDTH // 2 - 150, 200, 300, 60)
            music_button = pygame.Rect(WIDTH // 2 - 150, 300, 300, 60)
            language_button = pygame.Rect(WIDTH // 2 - 150, 400, 300, 60)

            # –ó–º—ñ–Ω–∞ –∫–æ–ª—å–æ—Ä—É –∫–Ω–æ–ø–æ–∫
            sound_color = HOVER_COLOR if self.settings["sound"] else BUTTON_COLOR
            music_color = HOVER_COLOR if self.settings["music"] else BUTTON_COLOR
            language_color = BUTTON_COLOR  # –¢—É—Ç –º–æ–∂–Ω–∞ –¥–æ–¥–∞—Ç–∏ –∑–º—ñ–Ω—É –∫–æ–ª—å–æ—Ä—É, —è–∫—â–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ

            pygame.draw.rect(self.screen, sound_color, sound_button, border_radius=10)
            pygame.draw.rect(self.screen, music_color, music_button, border_radius=10)
            pygame.draw.rect(self.screen, language_color, language_button, border_radius=10)

            sound_label = self.font.render("–ó–≤—É–∫: –í–∫–ª—é—á–µ–Ω–æ" if self.settings["sound"] else "–ó–≤—É–∫: –í–∏–º–∫–Ω–µ–Ω–æ", True, TEXT_COLOR)
            music_label = self.font.render("–ú—É–∑–∏–∫–∞: –í–∫–ª—é—á–µ–Ω–æ" if self.settings["music"] else "–ú—É–∑–∏–∫–∞: –í–∏–º–∫–Ω–µ–Ω–æ", True, TEXT_COLOR)
            language_label = self.font.render("–ú–æ–≤–∞: " + (self.languages[self.settings["language"]]["play"] if self.settings["language"] == "uk" else "English"), True, TEXT_COLOR)

            self.screen.blit(sound_label, (sound_button.centerx - sound_label.get_width() // 2, sound_button.centery - sound_label.get_height() // 2))
            self.screen.blit(music_label, (music_button.centerx - music_label.get_width() // 2, music_button.centery - music_label.get_height() // 2))
            self.screen.blit(language_label, (language_button.centerx - language_label.get_width() // 2, language_button.centery - language_label.get_height() // 2))

            # –ö–Ω–æ–ø–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è
            save_button = pygame.Rect(WIDTH // 2 - 150, HEIGHT - 100, 300, 60)
            pygame.draw.rect(self.screen, BUTTON_COLOR, save_button, border_radius=10)
            save_label = self.font.render("–ó–±–µ—Ä–µ–≥—Ç–∏", True, TEXT_COLOR)
            self.screen.blit(save_label, (save_button.centerx - save_label.get_width() // 2, save_button.centery - save_label.get_height() // 2))

            pygame.display.flip()

            for event in pygame.event.get():
                if event.type == pygame.QUIT:
                    self.exit_game()
                elif event.type == pygame.MOUSEBUTTONDOWN:
                    if sound_button.collidepoint(event.pos):
                        self.settings["sound"] = not self.settings["sound"]
                    if music_button.collidepoint(event.pos):
                        self.settings["music"] = not self.settings["music"]
                    if language_button.collidepoint(event.pos):
                        # –ó–º—ñ–Ω–∞ –º–æ–≤–∏ (—Ü–∏–∫–ª –º—ñ–∂ –¥–æ—Å—Ç—É–ø–Ω–∏–º–∏ –º–æ–≤–∞–º–∏)
                        languages_list = list(self.languages.keys())
                        current_index = languages_list.index(self.settings["language"])
                        self.settings["language"] = languages_list[(current_index + 1) % len(languages_list)]
                    if save_button.collidepoint(event.pos):
                        save_settings(self.settings)  # –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è
                        settings_active = False
                        self.show_menu()

    def change_nickname(self):
        input_active = True
        input_text = self.settings["nickname"]
        input_box = pygame.Rect(WIDTH // 2 - 150, HEIGHT // 2 - 20, 300, 60)

        while input_active:
            self.screen.fill(BG_COLOR)
            title_text = self.font.render("–ó–º—ñ–Ω–∞ –Ω—ñ–∫–Ω–µ–π–º—É", True, TEXT_COLOR)
            self.screen.blit(title_text, (WIDTH // 2 - title_text.get_width() // 2, 100))

            text_surface = self.font.render(input_text, True, TEXT_COLOR)
            self.screen.blit(text_surface, (input_box.x + 10, input_box.y + 10))

            pygame.draw.rect(self.screen, BUTTON_COLOR, input_box, border_radius=10)

            back_button = pygame.Rect(WIDTH // 2 - 150, HEIGHT - 100, 300, 60)
            pygame.draw.rect(self.screen, BUTTON_COLOR, back_button, border_radius=10)
            back_label = self.font.render("–ù–∞–∑–∞–¥", True, TEXT_COLOR)
            self.screen.blit(back_label, (back_button.centerx - back_label.get_width() // 2, back_button.centery - back_label.get_height() // 2))

            pygame.display.flip()

            for event in pygame.event.get():
                if event.type == pygame.QUIT:
                    self.exit_game()
                elif event.type == pygame.KEYDOWN:
                    if event.key == pygame.K_BACKSPACE:
                        input_text = input_text[:-1]
                    elif event.key == pygame.K_RETURN:
                        self.settings["nickname"] = input_text
                        save_settings(self.settings)
                        input_active = False
                        self.show_menu()
                    else:
                        input_text += event.unicode
                elif event.type == pygame.MOUSEBUTTONDOWN:
                    if back_button.collidepoint(event.pos):
                        input_active = False
                        self.show_menu()

    def play_menu_music(self):
        menu_music_path = resource_path("assets/music/menu_music.mp3")
        if os.path.exists(menu_music_path):
            pygame.mixer.music.stop()
        pygame.mixer.music.load(menu_music_path)
        pygame.mixer.music.play(-1)

    def play_game_music(self):
        game_music_path = resource_path("assets/music/Snake_Rattle_Dendy.mp3")
        if os.path.exists(game_music_path) and self.settings["music"]:
            pygame.mixer.music.stop()
        pygame.mixer.music.load(game_music_path)
        pygame.mixer.music.play(-1)

    def play_training_music(self):
        training_music_path = resource_path("assets/music/training-mode.mp3")
        if os.path.exists(training_music_path) and self.settings["music"]:
            pygame.mixer.music.stop()
        pygame.mixer.music.load(training_music_path)
        pygame.mixer.music.play(-1)

    def play_level_music(self, music_file):
        path = resource_path(f"assets/levls/level1.mp3")
        if os.path.exists(path) and self.settings["music"]:
         pygame.mixer.music.stop()
         pygame.mixer.music.load(path)
         pygame.mixer.music.play(-1)


    def run_game(self, training=False):
        self.running = True
        self.direction_vector = pygame.math.Vector2(1, 0)
        if training:
         self.play_training_music()
        else:
         self.play_game_music()

        self.start_snake()

        while self.running:
            self.handle_events(training=training)
            self.update_snake()
            self.check_collisions()
            self.draw()
            self.clock.tick(15 + self.score // 5)
        self.update_snake()
        self.check_collisions()
        self.draw()
        self.clock.tick(15 + self.score // 5)

        self.save_score_to_leaderboard(training=training)
        self.running = False
        self.show_game_over()

    def show_game_over(self):
        game_over_text = self.font.render("–ì–†–ê –ó–ê–ö–Ü–ù–ß–ï–ù–ê", True, TEXT_COLOR)
        self.screen.fill(BG_COLOR)
        self.screen.blit(game_over_text, (self.width // 2 - game_over_text.get_width() // 2, self.height // 3))

        retry_button = pygame.Rect(self.width // 2 - 150, self.height // 2 - 60, 300, 60)
        exit_button = pygame.Rect(self.width // 2 - 150, self.height // 2 + 60, 300, 60)

        buttons = [(retry_button, "–ü–æ–≤—Ç–æ—Ä–∏—Ç–∏"), (exit_button, "–ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é")]

        for rect, text in buttons:
            pygame.draw.rect(self.screen, BUTTON_COLOR, rect, border_radius=10)
            label = self.font.render(text, True, TEXT_COLOR)
            self.screen.blit(label, (rect.centerx - label.get_width() // 2, rect.centery - label.get_height() // 2))
            self.draw_emoji("skull", self.width // 2 - 32, self.height // 2 - 220)

        pygame.display.flip()

        waiting_for_input = True
        while waiting_for_input:
            for event in pygame.event.get():
                if event.type == pygame.QUIT:
                    self.exit_game()
                elif event.type == pygame.MOUSEBUTTONDOWN:
                    if retry_button.collidepoint(event.pos):
                        waiting_for_input = False
                        self.run_game()  # –ü—Ä–æ–±—É—î–º–æ –∑–Ω–æ–≤—É
                    elif exit_button.collidepoint(event.pos):
                        waiting_for_input = False
                        self.show_menu()  # –ü–æ–≤–µ—Ä—Ç–∞—î–º–æ—Å—å –¥–æ –º–µ–Ω—é

    def run_training_mode(self):
        self.running = True
        self.direction_vector = pygame.math.Vector2(1, 0)
        self.play_training_music()
        self.start_snake()

        while self.running:
            self.handle_events(training=True)
            self.update_snake()
            self.check_collisions()
            self.draw()
            self.clock.tick(15 + self.score // 5)
        self.update_snake()
        self.check_collisions()
        self.draw()
        self.clock.tick(15 + self.score // 5)

        self.save_score_to_leaderboard(training=True)
        self.running = False
        self.show_game_over()


    def start_snake(self):
        self.speed = CELL_SIZE
        self.head_pos = pygame.math.Vector2(self.width // 2, self.height // 2)
        self.direction_vector = pygame.math.Vector2(1, 0)
        self.snake = [self.head_pos.copy() - pygame.math.Vector2(i * CELL_SIZE, 0) for i in range(5)]
        self.head_pos = self.snake[0].copy()
        self.score = 0
        self.foods = self.generate_foods()

    def handle_events(self, training=False):
        for event in pygame.event.get():
            if event.type == pygame.QUIT:
                self.exit_game()
            elif event.type == pygame.KEYDOWN:
                if event.key == K_ESCAPE:
                    self.show_pause_menu()  # –í–∏–∫–ª–∏–∫–∞—î–º–æ –º–µ–Ω—é –ø–∞—É–∑–∏
                elif event.key == K_UP and self.direction_vector.y == 0:
                    self.direction_vector = pygame.math.Vector2(0, -1)
                elif event.key == K_DOWN and self.direction_vector.y == 0:
                    self.direction_vector = pygame.math.Vector2(0, 1)
                elif event.key == K_LEFT and self.direction_vector.x == 0:
                    self.direction_vector = pygame.math.Vector2(-1, 0)
                elif event.key == K_RIGHT and self.direction_vector.x == 0:
                    self.direction_vector = pygame.math.Vector2(1, 0)
            elif event.type == pygame.MOUSEBUTTONDOWN:
             if self.next_level_available and self.next_button_rect and self.next_button_rect.collidepoint(event.pos):
                self.next_level_available = False
                self.run_game_with_level(self.current_level + 1)

    def update_snake(self):
        self.head_pos += self.direction_vector * self.speed
        if not self.training_mode:
            if (self.head_pos.x < 0 or self.head_pos.x >= self.width or
                self.head_pos.y < 0 or self.head_pos.y >= self.height):
                if self.settings["sound"]:
                    self.sounds["collision"].play()
                self.running = False
                return
        # –û–±–º–µ–∂–µ–Ω–Ω—è –∑–º—ñ—ó –Ω–∞ –º–µ–∂–∞—Ö –µ–∫—Ä–∞–Ω—É
        self.head_pos.x = max(0, min(self.width - CELL_SIZE, self.head_pos.x))
        self.head_pos.y = max(0, min(self.height - CELL_SIZE, self.head_pos.y))

        self.snake.insert(0, self.head_pos.copy())
        ate = False
        for food in self.foods:
            if self.head_pos.distance_to(food['pos']) < CELL_SIZE:
                self.score += food['points']
                if self.settings["sound"]:
                    self.sounds["eat"].play()
                self.foods.remove(food)
                pos, food_type = self.generate_food()
                points = 1 if food_type == "normal" else 5
                self.foods.append({'pos': pos, 'type': food_type, 'points': points})
                ate = True
                break
        if not ate:
            self.snake.pop()

    def check_collisions(self):
        if any(self.head_pos.distance_to(segment) < CELL_SIZE for segment in self.snake[1:]):
            if self.settings["sound"]:
                self.sounds["collision"].play()
            self.running = False

    def draw(self):
        self.screen.fill(BG_COLOR)

        # –ú–∞–ª—é—î–º–æ –∑–º—ñ–π–∫—É
        for segment in self.snake:
            pygame.draw.ellipse(self.screen, TEXT_COLOR, (segment.x, segment.y, CELL_SIZE, CELL_SIZE))

        # –ú–∞–ª—é—î–º–æ —ó–∂—É
        for food in self.foods:
            color = SPECIAL_FOOD_COLOR if food['type'] == "special" else FOOD_COLOR
            pygame.draw.ellipse(self.screen, color, (food['pos'].x, food['pos'].y, CELL_SIZE, CELL_SIZE))

        # –í–∏–≤–æ–¥–∏–º–æ —Ä–∞—Ö—É–Ω–æ–∫
        score_text = self.font.render(f"–†–∞—Ö—É–Ω–æ–∫: {self.score}", True, TEXT_COLOR)
        self.screen.blit(score_text, (10, 10))

        # –í–∏–≤–æ–¥–∏–º–æ –Ω–∞–∑–≤—É —Ä—ñ–≤–Ω—è (—è–∫—â–æ –¥–æ—Å—Ç—É–ø–Ω–æ)
        if hasattr(self, 'current_level') and hasattr(self, 'levels'):
            try:
                level_name = self.levels[self.current_level]["name"]
                level_text = self.font.render(f"–†—ñ–≤–µ–Ω—å: {level_name}", True, TEXT_COLOR)
                self.screen.blit(level_text, (self.width - level_text.get_width() - 10, 10))
            except (IndexError, KeyError, TypeError):
                pass

        left_text = None

        if hasattr(self, 'levels') and hasattr(self, 'current_level') and not self.training_mode:
            try:
               target = self.levels[self.current_level].get("target_score", 0)
               if self.score < target:
                left = target - int(self.score)
                left_text = self.font.render(f"–î–æ –Ω–∞—Å—Ç—É–ø–Ω–æ–≥–æ —Ä—ñ–≤–Ω—è: {left} –æ—á.", True, TEXT_COLOR)
                self.screen.blit(left_text, (10, 40))
            except Exception as e:
               print("‚ö† –ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –æ–±—á–∏—Å–ª–µ–Ω–Ω—ñ –∑–∞–ª–∏—à–∫—É –¥–æ —Ä—ñ–≤–Ω—è:", e)

        if left_text:
            self.screen.blit(left_text, (10, 40))

# –Ø–∫—â–æ –≤—ñ–¥–∫—Ä–∏–≤—Å—è –Ω–æ–≤–∏–π —Ä—ñ–≤–µ–Ω—å ‚Äî –ø–æ–∫–∞–∑—É—î–º–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è 3 —Å–µ–∫—É–Ω–¥–∏
        if self.new_level_unlocked_message and pygame.time.get_ticks() - self.new_level_timer < 3000:
         msg = self.font.render(self.new_level_unlocked_message, True, (255, 215, 0))
         self.screen.blit(msg, (self.width // 2 - msg.get_width() // 2, self.height // 2 - 100))
         self.draw_emoji("trophy", self.width // 2 - 32, self.height // 2 - 180)
         # –ö–Ω–æ–ø–∫–∞ "–ù–∞—Å—Ç—É–ø–Ω–∏–π —Ä—ñ–≤–µ–Ω—å", —è–∫—â–æ –¥–æ—Å—Ç—É–ø–Ω–∞
         if self.next_level_available:
           next_button = pygame.Rect(self.width // 2 - 150, self.height // 2, 300, 60)
           pygame.draw.rect(self.screen, (0, 150, 0), next_button, border_radius=10)
           next_label = self.font.render("‚û° –ù–∞—Å—Ç—É–ø–Ω–∏–π —Ä—ñ–≤–µ–Ω—å", True, (0, 0, 0))
           self.screen.blit(next_label, (next_button.centerx - next_label.get_width() // 2, next_button.centery - next_label.get_height() // 2))
           self.next_button_rect = next_button  # –∑–±–µ—Ä—ñ–≥–∞—î–º–æ –¥–ª—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ –∫–ª—ñ–∫—É
        else:
           self.next_button_rect = None

        pygame.display.flip()


    def generate_foods(self):
        return [{'pos': self.generate_food()[0], 'type': self.generate_food()[1], 'points': 5 if self.generate_food()[1]=='special' else 1} for _ in range(FOOD_COUNT)]

    def generate_food(self):
        while True:
            pos = pygame.math.Vector2(random.randint(0, self.width - CELL_SIZE), random.randint(0, self.height - CELL_SIZE))
            if all(pos.distance_to(segment) > CELL_SIZE for segment in self.snake):
                food_type = "special" if random.random() < SPECIAL_FOOD_CHANCE else "normal"
                return pos, food_type

    def exit_game(self):
        pygame.quit()
        sys.exit()

    def show_pause_menu(self):
        blur_surface = pygame.Surface((self.width, self.height), pygame.SRCALPHA)
        blur_surface.fill((0, 0, 0, 150))  # –ù–∞–ø—ñ–≤–ø—Ä–æ–∑–æ—Ä–∏–π —á–æ—Ä–Ω–∏–π —Ñ–æ–Ω
        self.screen.blit(blur_surface, (0, 0))

        font = pygame.font.Font(None, 50)
        continue_button = pygame.Rect(self.width // 2 - 150, self.height // 2 - 100, 300, 60)
        settings_button = pygame.Rect(self.width // 2 - 150, self.height // 2, 300, 60)
        exit_button = pygame.Rect(self.width // 2 - 150, self.height // 2 + 100, 300, 60)

        buttons = [(continue_button, "–ü—Ä–æ–¥–æ–≤–∂–∏—Ç–∏"), (settings_button, "–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è"), (exit_button, "–ù–∞–∑–∞–¥ –¥–æ –º–µ–Ω—é")]

        for rect, text in buttons:
            pygame.draw.rect(self.screen, BUTTON_COLOR, rect, border_radius=10)
            label = font.render(text, True, TEXT_COLOR)
            self.screen.blit(label, (rect.centerx - label.get_width() // 2, rect.centery - label.get_height() // 2))
            self.draw_emoji("snake", self.width // 2 - 32, self.height // 2 - 180)

        pygame.display.flip()

        waiting_for_input = True
        while waiting_for_input:
            for event in pygame.event.get():
                if event.type == pygame.QUIT:
                    self.exit_game()
                elif event.type == pygame.MOUSEBUTTONDOWN:
                    if continue_button.collidepoint(event.pos):
                        waiting_for_input = False
                        self.running = True  # –ü—Ä–æ–¥–æ–≤–∂—É—î–º–æ –≥—Ä—É
                    elif settings_button.collidepoint(event.pos):
                        self.show_settings()  # –ü–æ–∫–∞–∑—É—î–º–æ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è
                    elif exit_button.collidepoint(event.pos):
                        self.show_menu()  # –í–∏—Ö–æ–¥–∏–º–æ –≤ –º–µ–Ω—é

    def show_settings(self):
        settings_active = True
        while settings_active:
            self.screen.fill(BG_COLOR)
            title = self.font.render("–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è", True, TEXT_COLOR)
            self.screen.blit(title, (self.width // 2 - 150, 100))

            music_state = "–£–≤—ñ–º–∫–Ω–µ–Ω–æ" if self.settings["music"] else "–í–∏–º–∫–Ω–µ–Ω–æ"
            sound_state = "–£–≤—ñ–º–∫–Ω–µ–Ω–æ" if self.settings["sound"] else "–í–∏–º–∫–Ω–µ–Ω–æ"
            language_state = self.settings["language"].upper()

            music_button = pygame.Rect(self.width // 2 - 150, 180, 300, 60)
            sound_button = pygame.Rect(self.width // 2 - 150, 260, 300, 60)
            language_button = pygame.Rect(self.width // 2 - 150, 340, 300, 60)
            back_button = pygame.Rect(self.width // 2 - 150, self.height - 100, 300, 60)

            buttons = [
                (music_button, f"–ú—É–∑–∏–∫–∞: {music_state}"),
                (sound_button, f"–ó–≤—É–∫–∏: {sound_state}"),
                (language_button, f"–ú–æ–≤–∞: {language_state}"),
                (back_button, "–ù–∞–∑–∞–¥")
            ]

            for rect, text in buttons:
                pygame.draw.rect(self.screen, BUTTON_COLOR, rect, border_radius=10)
                label = self.font.render(text, True, TEXT_COLOR)
                self.screen.blit(label, (rect.centerx - label.get_width() // 2, rect.centery - label.get_height() // 2))

            pygame.display.flip()

            for event in pygame.event.get():
                if event.type == pygame.QUIT:
                    self.exit_game()
                elif event.type == pygame.MOUSEBUTTONDOWN:
                    if music_button.collidepoint(event.pos):
                        self.settings["music"] = not self.settings["music"]
                        save_settings(self.settings)
                    elif sound_button.collidepoint(event.pos):
                        self.settings["sound"] = not self.settings["sound"]
                        save_settings(self.settings)
                    elif language_button.collidepoint(event.pos):
                        self.change_language()  # –î–æ–¥–∞–º–æ —Ñ—É–Ω–∫—Ü—ñ—é –¥–ª—è –∑–º—ñ–Ω–∏ –º–æ–≤–∏
                    elif back_button.collidepoint(event.pos):
                        settings_active = False
                        self.show_menu()  # –ü–æ–≤–µ—Ä—Ç–∞—î–º–æ—Å—å –≤ –º–µ–Ω—é
                elif event.type == pygame.KEYDOWN:
                    if event.key == K_ESCAPE:
                        settings_active = False
                        self.show_menu()  # –ü–æ–≤–µ—Ä—Ç–∞—î–º–æ—Å—å –≤ –º–µ–Ω—é

    def change_language(self):
        languages = ['uk', 'en', 'ru', 'be', 'pl']
        current_index = languages.index(self.settings["language"])
        new_language = languages[(current_index + 1) % len(languages)]
        self.settings["language"] = new_language
        save_settings(self.settings)


    def loading_screen(self):
        loading_active = True
        percent = 0
        start_time = pygame.time.get_ticks()
        duration = 17000  # 17 —Å–µ–∫—É–Ω–¥

        font = pygame.font.Font(None, 50)

        while loading_active:
            now = pygame.time.get_ticks()
            elapsed = now - start_time
            percent = min(100, int((elapsed / duration) * 100))

            self.screen.fill((20, 20, 20))
            text = font.render("–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è... –û–ø—Ç–∏–º—ñ–∑–∞—Ü—ñ—è –≥—Ä–∏", True, (0, 255, 0))
            self.screen.blit(text, (self.width // 2 - text.get_width() // 2, self.height // 2 - 80))

            # –ü—Ä–æ–≥—Ä–µ—Å-–±–∞—Ä
            bar_width = 400
            bar_height = 30
            bar_x = self.width // 2 - bar_width // 2
            bar_y = self.height // 2

            pygame.draw.rect(self.screen, (100, 100, 100), (bar_x, bar_y, bar_width, bar_height), border_radius=10)
            pygame.draw.rect(self.screen, (0, 200, 0), (bar_x, bar_y, bar_width * (percent / 100), bar_height), border_radius=10)

            percent_text = font.render(f"{percent}%", True, (255, 255, 255))
            self.screen.blit(percent_text, (self.width // 2 - percent_text.get_width() // 2, bar_y + 40))

            pygame.display.flip()
            self.clock.tick(60)

            if percent >= 100:
                loading_active = False
                print("‚úÖ –û–ø—Ç–∏–º—ñ–∑–∞—Ü—ñ—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞!")

        self.optimize_game()

    def optimize_game(self):
        print("‚öô –û–ø—Ç–∏–º—ñ–∑–∞—Ü—ñ—è...")
        required_files = [
            "assets/music/eat.wav",
            "assets/music/collision.wav",
            "assets/music/click.wav",
            "assets/music/menu_music.mp3"
        ]
        for f in required_files:
            if not os.path.exists(resource_path(f)):
                print(f"‚ö† –ù–µ –∑–Ω–∞–π–¥–µ–Ω–æ —Ñ–∞–π–ª: {f}")
            else:
                print(f"‚úÖ –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ: {f}")

if __name__ == "__main__":
    try:
        game = SnakeGame()
    except Exception:
        log_exception()

        pygame.init()
        screen = pygame.display.set_mode((800, 600))
        font = pygame.font.Font(None, 40)
        screen.fill((20, 0, 0))

        error_texts = [
            "Error detected",
            "Please restart the game",
            "If the issue persists, contact AFER support",
            "Website ‚Äì https://afercorporftaon.onepage.me/"
        ]

        for i, line in enumerate(error_texts):
            rendered = font.render(line, True, (255, 0, 0))
            screen.blit(rendered, (400 - rendered.get_width() // 2, 200 + i * 50))

        pygame.display.flip()

        waiting = True
        while waiting:
            for event in pygame.event.get():
                if event.type == pygame.QUIT or (event.type == pygame.KEYDOWN and event.key == pygame.K_ESCAPE):
                    waiting = False
        pygame.quit()
